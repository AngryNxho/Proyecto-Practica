name: CI - Integración Continua

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  backend-quality:
    name: Backend - Calidad y Tests
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Configurar Python 3.12
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
        
    - name: Instalar dependencias
      working-directory: ./S1/backend
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        mkdir -p logs
        
    - name: Ejecutar linter y análisis de calidad
      working-directory: ./S1/backend
      run: |
        python check_quality.py
      continue-on-error: true
        
    - name: Verificar salud del sistema
      working-directory: ./S1/backend
      run: |
        python verificar_salud.py
      continue-on-error: true
        
    - name: Ejecutar migraciones
      working-directory: ./S1/backend
      run: |
        python manage.py makemigrations --check --dry-run
      continue-on-error: true
        
    - name: Ejecutar tests
      working-directory: ./S1/backend
      run: |
        python manage.py test

  frontend-quality:
    name: Frontend - Calidad y Build
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Configurar Node.js 20
      uses: actions/setup-node@v3
      wi
    - name: Instalar dependencias
      working-directory: ./S1/frontend
      run: npm ci --legacy-peer-depslar dependencias
      working-directory: ./S1/frontend
      run: npm ci
      
    - name: Ejecutar linter
      working-directory: ./S1/frontend
      run: npm run lint
      continue-on-error: true
      
    - name: Ejecutar tests
      working-directory: ./S1/frontend
      run: npm run test
      continue-on-error: true
      
    - name: Compilar producción
      working-directory: ./S1/frontend
      run: npm run build
      
    - name: Verificar build
      working-directory: ./S1/frontend
      run: |
        if [ ! -d "dist" ]; then
          echo "Error: directorio dist no generado"
          exit 1
        fi
        echo "✓ Build exitoso - archivos generados en dist/"

  integration:
    name: Verificación de Integración
    needs: [backend-quality, frontend-quality]
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Validación exitosa
      run: |
        echo "✓ Backend - Calidad y tests pasados"
        echo "✓ Frontend - Build compilado exitosamente"
        echo "✓ Pipeline CI completado"
